Option Explicit

Sub ExporterUrlsVersWord()
    Dim ws As Worksheet
    Dim lastRow As Long, i As Long
    Dim url As String
    Dim htmlText As String
    Dim htmlDoc As Object        ' HTMLDocument
    Dim mainNode As Object       ' Element principal de contenu
    Dim wdApp As Object          ' Word.Application
    Dim wdDoc As Object          ' Word.Document
    
    Set ws = ActiveSheet
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row
    
    ' Lancer Word
    On Error Resume Next
    Set wdApp = GetObject(, "Word.Application")
    On Error GoTo 0
    If wdApp Is Nothing Then
        Set wdApp = CreateObject("Word.Application")
    End If
    wdApp.Visible = True
    
    ' üîπ Je pars de la ligne 2 en supposant une en-t√™te en A1
    For i = 2 To lastRow
        url = Trim$(ws.Cells(i, "A").Value)
        If url <> "" Then
            
            ' On cr√©e d√©j√† le document Word pour voir si au moins √ßa marche
            Set wdDoc = wdApp.Documents.Add
            
            ' Titre du doc = URL
            wdDoc.BuiltInDocumentProperties("Title").Value = url
            
            ' R√©cup√©ration du HTML
            htmlText = GetHtmlFromUrl(url)
            
            If htmlText = "" Then
                ' On √©crit au moins l'URL + info erreur
                With wdDoc.Range
                    .Text = "URL : " & url & vbCrLf & _
                            "[Aucun contenu HTML r√©cup√©r√© pour cette page]" & vbCrLf
                End With
            Else
                ' Charger le HTML
                Set htmlDoc = CreateObject("HTMLFile")
                htmlDoc.Open
                htmlDoc.Write htmlText
                htmlDoc.Close
                
                ' Zone principale de contenu
                Set mainNode = GetMainContentNode(htmlDoc)
                If mainNode Is Nothing Then
                    On Error Resume Next
                    Set mainNode = htmlDoc.getElementsByTagName("body")(0)
                    On Error GoTo 0
                End If
                
                If mainNode Is Nothing Then
                    With wdDoc.Range
                        .Text = "URL : " & url & vbCrLf & _
                                "[Impossible de trouver la zone de contenu]" & vbCrLf
                    End With
                Else
                    ' Remplir le doc Word avec tableau
                    RemplirDocumentWord wdDoc, htmlDoc, mainNode, url
                End If
            End If
            
        End If
    Next i
    
    MsgBox "Termin√©. V√©rifiez vos documents Word ouverts."
End Sub

'-------------------------
' R√©cup√©ration HTML
'-------------------------
Private Function GetHtmlFromUrl(ByVal url As String) As String
    Dim http As Object
    
    On Error GoTo ErrHandler
    
    Set http = CreateObject("MSXML2.XMLHTTP")
    http.Open "GET", url, False
    http.send
    
    If http.Status = 200 Then
        GetHtmlFromUrl = http.responseText
    Else
        GetHtmlFromUrl = ""
    End If
    
    Exit Function
ErrHandler:
    GetHtmlFromUrl = ""
End Function

'-------------------------
' Zone de contenu principale
'-------------------------
Private Function GetMainContentNode(ByVal htmlDoc As Object) As Object
    Dim node As Object
    Dim divs As Object
    Dim i As Long
    Dim idsToTry As Variant
    Dim classToTry As Variant
    
    On Error Resume Next
    
    ' 1) Balise <main>
    Set node = htmlDoc.getElementsByTagName("main")(0)
    If Not node Is Nothing Then
        Set GetMainContentNode = node
        Exit Function
    End If
    
    ' 2) Ids les plus fr√©quents
    idsToTry = Array("content", "main", "primary", "page", "main-content", "content-main")
    For i = LBound(idsToTry) To UBound(idsToTry)
        Set node = htmlDoc.getElementById(idsToTry(i))
        If Not node Is Nothing Then
            Set GetMainContentNode = node
            Exit Function
        End If
    Next i
    
    ' 3) Classes fr√©quentes
    classToTry = Array("content", "main-content", "page-content", "article-body")
    Set divs = htmlDoc.getElementsByTagName("div")
    For i = 0 To divs.Length - 1
        Set node = divs.Item(i)
        If Not node Is Nothing Then
            If node.className <> "" Then
                If ClassNameMatch(node.className, classToTry) Then
                    Set GetMainContentNode = node
                    Exit Function
                End If
            End If
        End If
    Next i
    
    Set GetMainContentNode = Nothing
End Function

Private Function ClassNameMatch(ByVal className As String, ByVal classArray As Variant) As Boolean
    Dim c As Variant
    Dim lower As String
    lower = LCase$(className)
    For Each c In classArray
        If InStr(1, lower, LCase$(CStr(c)), vbTextCompare) > 0 Then
            ClassNameMatch = True
            Exit Function
        End If
    Next c
    ClassNameMatch = False
End Function

'-------------------------
' Remplir le doc Word
'-------------------------
Private Sub RemplirDocumentWord(ByVal wdDoc As Object, ByVal htmlDoc As Object, ByVal mainNode As Object, ByVal url As String)
    Dim tbl As Object     ' Word.Table
    Dim rng As Object     ' Word.Range
    Dim titre As String
    Dim metaDesc As String
    
    ' Cr√©er tableau 1 ligne / 2 colonnes
    Set rng = wdDoc.Range(0, 0)
    Set tbl = wdDoc.Tables.Add(rng, 1, 2)
    
    tbl.Cell(1, 1).Range.Text = "Type"
    tbl.Cell(1, 2).Range.Text = "Texte"
    
    ' M√©tadonn√©es
    titre = GetPageTitle(htmlDoc)
    metaDesc = GetMetaContent(htmlDoc, "description")
    
    AddRowToTable tbl, "URL", url, Nothing
    If titre <> "" Then AddRowToTable tbl, "META_TITLE", titre, Nothing
    If metaDesc <> "" Then AddRowToTable tbl, "META_DESCRIPTION", metaDesc, Nothing
    
    ' Ligne de s√©paration
    AddRowToTable tbl, "-----", "-----", Nothing
    
    ' Parcourir le contenu
    WalkHtmlNode mainNode, tbl
End Sub

Private Function GetPageTitle(ByVal htmlDoc As Object) As String
    On Error Resume Next
    GetPageTitle = ""
    If htmlDoc.getElementsByTagName("title").Length > 0 Then
        GetPageTitle = Trim$(htmlDoc.getElementsByTagName("title")(0).innerText)
    End If
End Function

Private Function GetMetaContent(ByVal htmlDoc As Object, ByVal metaName As String) As String
    Dim metas As Object
    Dim m As Object
    GetMetaContent = ""
    
    On Error Resume Next
    Set metas = htmlDoc.getElementsByTagName("meta")
    If metas Is Nothing Then Exit Function
    
    For Each m In metas
        If LCase$(m.getAttribute("name") & "") = LCase$(metaName) Then
            GetMetaContent = Trim$(m.getAttribute("content") & "")
            Exit Function
        End If
    Next m
End Function

'-------------------------
' Ajout de lignes au tableau
'-------------------------
Private Sub AddRowToTable(ByVal tbl As Object, ByVal typeTexte As String, ByVal contenu As String, ByVal elemHtml As Object)
    Dim newRowIndex As Long
    Dim cellRange As Object
    
    If Trim$(contenu) = "" Then Exit Sub
    
    newRowIndex = tbl.Rows.Count + 1
    tbl.Rows.Add
    
    tbl.Cell(newRowIndex, 1).Range.Text = typeTexte
    Set cellRange = tbl.Cell(newRowIndex, 2).Range
    cellRange.Text = contenu
    
    ' Enlever le caract√®re de fin de cellule pour travailler proprement
    cellRange.End = cellRange.End - 1
    
    If Not elemHtml Is Nothing Then
        ApplyHyperlinks elemHtml, cellRange
    End If
End Sub

'-------------------------
' Parcours HTML
'-------------------------
Private Sub WalkHtmlNode(ByVal node As Object, ByVal tbl As Object)
    Dim child As Object
    Dim li As Object
    Dim tagName As String
    Dim className As String
    
    For Each child In node.children
        On Error Resume Next
        tagName = UCase$(child.tagName & "")
        className = LCase$(child.className & "")
        On Error GoTo 0
        
        Select Case tagName
            Case "H1", "H2", "H3", "H4", "H5", "H6"
                AddRowToTable tbl, tagName, Trim$(child.innerText & ""), child
            
            Case "P"
                AddRowToTable tbl, "P", Trim$(child.innerText & ""), child
            
            Case "UL", "OL"
                For Each li In child.getElementsByTagName("li")
                    AddRowToTable tbl, "LISTE", Trim$(li.innerText & ""), li
                Next li
            
            Case "DETAILS"
                AddRowToTable tbl, "ACCORDEON", Trim$(child.innerText & ""), child
            
            Case Else
                If className <> "" Then
                    If InStr(1, className, "accordion", vbTextCompare) > 0 _
                       Or InStr(1, className, "accordeon", vbTextCompare) > 0 Then
                        AddRowToTable tbl, "ACCORDEON", Trim$(child.innerText & ""), child
                    ElseIf child.children.Length > 0 Then
                        WalkHtmlNode child, tbl
                    Else
                        AddRowToTable tbl, "P", Trim$(child.innerText & ""), child
                    End If
                Else
                    If child.children.Length > 0 Then
                        WalkHtmlNode child, tbl
                    Else
                        AddRowToTable tbl, "P", Trim$(child.innerText & ""), child
                    End If
                End If
        End Select
    Next child
End Sub

'-------------------------
' Hyperliens
'-------------------------
Private Sub ApplyHyperlinks(ByVal elemHtml As Object, ByVal cellRange As Object)
    Dim links As Object
    Dim a As Object
    Dim anchorText As String, href As String
    Dim rngSearch As Object, found As Boolean
    
    On Error Resume Next
    Set links = elemHtml.getElementsByTagName("a")
    If links Is Nothing Then Exit Sub
    If links.Length = 0 Then Exit Sub
    On Error GoTo 0
    
    For Each a In links
        On Error Resume Next
        href = a.href & ""
        anchorText = Trim$(a.innerText & "")
        On Error GoTo 0
        
        If href <> "" And anchorText <> "" Then
            Set rngSearch = cellRange.Duplicate
            rngSearch.End = rngSearch.End - 1
            
            With rngSearch.Find
                .ClearFormatting
                .Text = anchorText
                .Forward = True
                .Wrap = 0 ' wdFindStop
                found = .Execute
            End With
            
            If found Then
                cellRange.Hyperlinks.Add Anchor:=rngSearch, Address:=href, SubAddress:="", TextToDisplay:=anchorText
            End If
        End If
    Next a
End Sub