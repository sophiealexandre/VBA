Option Explicit

Sub StackAllSheets_KeepEverything()
    Const MASTER_NAME As String = "Stacked"
    Dim wb As Workbook: Set wb = ThisWorkbook
    Dim ws As Worksheet, wsMaster As Worksheet
    Dim rng As Range, lastCell As Range
    Dim pasteRow As Long, pasteCol As Long
    Dim srcRows As Long, srcCols As Long
    Dim r As Long, c As Long
    Dim srcColWidth As Double, tgtColWidth As Double
    Dim srcRowHeight As Double, tgtRowHeight As Double
    Dim includeHidden As Boolean
    
    ' === Paramètres ===
    includeHidden = True  ' True = inclure aussi les onglets masqués (puisqu’on garde tout)
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual
    
    ' === Obtenir/Créer la feuille MASTER en fin de classeur ===
    On Error Resume Next
    Set wsMaster = wb.Worksheets(MASTER_NAME)
    On Error GoTo 0
    
    If wsMaster Is Nothing Then
        Set wsMaster = wb.Worksheets.Add(After:=wb.Worksheets(wb.Worksheets.Count))
        On Error Resume Next
        wsMaster.Name = MASTER_NAME
        If Err.Number <> 0 Then
            Err.Clear
            wsMaster.Name = MASTER_NAME & "_" & Format(Now, "yyyymmdd_hhnnss")
        End If
        On Error GoTo 0
    Else
        ' Vider totalement (contenu + formats + colonnes/lignes)
        wsMaster.Cells.Clear
        wsMaster.Cells.RowHeight = wsMaster.StandardHeight
        wsMaster.Cells.ColumnWidth = wsMaster.StandardWidth
    End If
    
    ' On commence en ligne 1, colonne 2 (colonne 1 = nom d’onglet)
    pasteRow = 1
    pasteCol = 2
    
    ' Titre en ligne 1, col A
    wsMaster.Cells(1, 1).Value = "Source_Sheet"
    wsMaster.Cells(1, 1).Font.Bold = True
    
    ' === Boucle sur toutes les feuilles ===
    For Each ws In wb.Worksheets
        If ws.Name <> wsMaster.Name Then
            If includeHidden Or ws.Visible = xlSheetVisible Then
                ' Détecter la zone à copier (UsedRange peut contenir des scories; on fiabilise)
                If WorksheetHasData(ws) Then
                    ' Dernière cellule réellement utilisée
                    Set lastCell = ws.Cells.SpecialCells(xlCellTypeLastCell)
                    srcRows = lastCell.Row
                    srcCols = lastCell.Column
                    Set rng = ws.Range(ws.Cells(1, 1), ws.Cells(srcRows, srcCols))
                    
                    ' Coller un en-tête de bloc (nom d’onglet) si on n’est pas en tout début
                    If pasteRow > 1 Then
                        pasteRow = pasteRow + 1   ' ligne vide séparatrice
                    End If
                    
                    ' 1) Coller le contenu & formats COMPLETS
                    rng.Copy
                    wsMaster.Cells(pasteRow, pasteCol).PasteSpecial Paste:=xlPasteAll
                    Application.CutCopyMode = False
                    
                    ' 2) Reporter le nom de la feuille dans la colonne A pour toutes les lignes du bloc
                    wsMaster.Range(wsMaster.Cells(pasteRow, 1), _
                                   wsMaster.Cells(pasteRow + srcRows - 1, 1)).Value = ws.Name
                    
                    ' 3) Harmoniser les LARGEURS DE COLONNES (max entre existant et source)
                    For c = 1 To srcCols
                        srcColWidth = ws.Columns(c).ColumnWidth
                        tgtColWidth = wsMaster.Columns(pasteCol + c - 1).ColumnWidth
                        If srcColWidth > tgtColWidth Then
                            wsMaster.Columns(pasteCol + c - 1).ColumnWidth = srcColWidth
                        End If
                    Next c
                    
                    ' 4) Harmoniser les HAUTEURS DE LIGNES (max entre existant et source)
                    For r = 1 To srcRows
                        srcRowHeight = ws.Rows(r).RowHeight
                        tgtRowHeight = wsMaster.Rows(pasteRow + r - 1).RowHeight
                        If srcRowHeight > tgtRowHeight Then
                            wsMaster.Rows(pasteRow + r - 1).RowHeight = srcRowHeight
                        End If
                    Next r
                    
                    ' 5) Optionnel : reproduire les largeurs de colonnes de la colonne A (étiquette)
                    ' Garder une largeur raisonnable pour le nom de feuille
                    If wsMaster.Columns(1).ColumnWidth < 20 Then
                        wsMaster.Columns(1).ColumnWidth = 20
                    End If
                    
                    ' Avancer le curseur de collage (prochaine ligne après le bloc)
                    pasteRow = pasteRow + srcRows
                End If
            End If
        End If
    Next ws
    
    ' Geler la 1re ligne (étiquette "Source_Sheet")
    With wsMaster
        .Rows(1).Font.Bold = True
        .Activate
        .Range("B2").Select
        ActiveWindow.FreezePanes = False
        .Range("B2").Select
        ActiveWindow.FreezePanes = True
        .Range("A1").Select
    End With
    
    Application.Calculation = xlCalculationAutomatic
    Application.EnableEvents = True
    Application.ScreenUpdating = True
    
    MsgBox "Empilage terminé dans '" & wsMaster.Name & "'. Tout a été conservé.", vbInformation
End Sub

Private Function WorksheetHasData(sh As Worksheet) As Boolean
    ' Vérifie s’il y a au moins une cellule non vide dans la feuille
    Dim lastCell As Range
    On Error Resume Next
    Set lastCell = sh.Cells.SpecialCells(xlCellTypeLastCell)
    On Error GoTo 0
    If lastCell Is Nothing Then
        WorksheetHasData = False
    Else
        WorksheetHasData = Application.WorksheetFunction.CountA(sh.Range(sh.Cells(1, 1), lastCell)) > 0
    End If
End Function